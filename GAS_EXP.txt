const CONFIG = {
    GEMINI_API_KEY: '***',
    DISCORD_WEBHOOK_URL: '***',
    SCAN_WINDOW_DAYS: 21,
    USER_NAME: '***',
    TIMEZONE: "GMT+8"
};

/**
 * ä¸»å‹•æ¨é€åŠŸèƒ½ (Sentinel)
 */
function arielSentinel() {
    console.log("â° Ariel Sentinel æƒæå•Ÿå‹•...");
    const now = new Date();
    const future = new Date(now.getTime() + (CONFIG.SCAN_WINDOW_DAYS * 24 * 60 * 60 * 1000));
    let newItems = [];

    const cache = PropertiesService.getScriptProperties();
    let sentHistory = cache.getProperty('SENT_HISTORY') || "";

    try {
        // 1. æª¢æŸ¥æ—¥æ›†äº‹ä»¶
        const calendars = CalendarApp.getAllCalendars();
        calendars.forEach(cal => {
            try {
                const events = cal.getEvents(now, future);
                events.forEach(e => {
                    const itemID = `EVT_${e.getId()}_${e.getLastUpdated().getTime()}`;
                    if (sentHistory.indexOf(itemID) === -1) {
                        const timeStr = Utilities.formatDate(e.getStartTime(), CONFIG.TIMEZONE, "yyyy/MM/dd HH:mm");
                        newItems.push({ id: itemID, text: `[è¡Œç¨‹é å‘Š] ${e.getTitle()}, æ™‚é–“: ${timeStr}` });
                    }
                });
            } catch (calErr) {
                console.error(`[ERROR] æ—¥æ›†æƒæç•°å¸¸: ${cal.getName()}`);
            }
        });

        // 2. æª¢æŸ¥ Gmail æœªè®€éƒµä»¶
        try {
            const threads = GmailApp.search('is:unread', 0, 5);
            threads.forEach(t => {
                const itemID = `MAIL_${t.getId()}_${t.getLastMessageDate().getTime()}`;
                if (sentHistory.indexOf(itemID) === -1) {
                    newItems.push({ id: itemID, text: `[æ–°ä¿¡é€šçŸ¥] å¯„ä»¶è€…: ${t.getMessages()[0].getFrom()}, æ¨™é¡Œ: ${t.getFirstMessageSubject()}` });
                }
            });
        } catch (mailErr) {
            console.error(`[ERROR] éƒµä»¶æƒæç•°å¸¸: ${mailErr}`);
        }

        // 3. è™•ç†èˆ‡ç™¼é€
        if (newItems.length > 0) {
            const reportContext = newItems.map(item => item.text).join("\n");
            let arielSpeech = "";
            try {
                arielSpeech = callGeminiAI(reportContext);
            } catch (aiErr) {
                console.error(`[AI å¤±æ•—] ${aiErr.message}`);
                arielSpeech = `âš ï¸ AI è™•ç†å¤±æ•—ï¼ˆåŸå› ï¼š${aiErr.message}ï¼‰\n\nåŸå§‹æ‘˜è¦ï¼š\n` + reportContext;
            }

            sendToDiscord(arielSpeech);

            const newIDs = newItems.map(item => item.id).join(",");
            sentHistory = (sentHistory ? sentHistory + "," : "") + newIDs;
            const historyArray = sentHistory.split(",");
            if (historyArray.length > 200) {
                sentHistory = historyArray.slice(-200).join(",");
            }
            cache.setProperty('SENT_HISTORY', sentHistory);
            console.log("[SUCCESS] é€šçŸ¥å·²æ¨é€è‡³ Discordã€‚");
        } else {
            console.log("[INFO] ç„¡æ–°ç•°å‹•äº‹é …ã€‚");
        }
    } catch (err) {
        console.error("âŒ ç³»çµ±å´©æ½°: " + err.stack);
        sendToDiscord("âŒ Ariel ç³»çµ±ç™¼ç”Ÿåš´é‡éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Logsã€‚");
    }
}

function callGeminiAI(content) {
    // ğŸ’¡ é€™è£¡å°‡æ¨¡å‹æ”¹ç‚º 2.5-flash ä»¥ç²å¾—æ›´ç©©å®šçš„å…è²»é¡åº¦
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${CONFIG.GEMINI_API_KEY}`;
    const todayStr = Utilities.formatDate(new Date(), CONFIG.TIMEZONE, "yyyy/MM/dd HH:mm");
    const prompt = `ç¾åœ¨æ™‚é–“æ˜¯ ${todayStr}ã€‚ä½¿ç”¨è€…æ˜¯ ${CONFIG.USER_NAME}ã€‚è«‹å½™æ•´ä»¥ä¸‹æ–°æ”¶åˆ°çš„è¡Œç¨‹èˆ‡éƒµä»¶ï¼Œä¸¦ä»¥å°ˆæ¥­ç§˜æ›¸ Ariel çš„èº«åˆ†é€²è¡Œè¦ªåˆ‡æé†’ï¼ˆç¹é«”ä¸­æ–‡ï¼‰ï¼š\n${content}`;
    
    const payload = { "contents": [{ "parts": [{ "text": prompt }] }] };
    const options = { 
        "method": "post", 
        "contentType": "application/json", 
        "payload": JSON.stringify(payload), 
        "muteHttpExceptions": true 
    };

    const response = UrlFetchApp.fetch(url, options);
    const statusCode = response.getResponseCode();
    const responseText = response.getContentText();
    
    if (statusCode !== 200) {
        console.error(`[Gemini] API éŒ¯èª¤å›æ‡‰: ${responseText}`);
        throw new Error(`Gemini API HTTP ${statusCode}: ${responseText.substring(0, 100)}`);
    }

    const result = JSON.parse(responseText);
    if (result.candidates && result.candidates[0].content) {
        return result.candidates[0].content.parts[0].text;
    }
    throw new Error("Gemini API å›å‚³çµæ§‹ç•°å¸¸");
}

function sendToDiscord(message) {
    UrlFetchApp.fetch(CONFIG.DISCORD_WEBHOOK_URL, {
        "method": "post", "contentType": "application/json",
        "payload": JSON.stringify({ "username": "Ariel åŸ·è¡Œç¥•æ›¸", "content": message })
    });
}

function setupTrigger() {
    const triggers = ScriptApp.getProjectTriggers();
    triggers.forEach(t => {
        if (t.getHandlerFunction() === 'arielSentinel') {
            ScriptApp.deleteTrigger(t);
        }
    });

    ScriptApp.newTrigger('arielSentinel')
        .timeBased()
        .everyMinutes(10)
        .create();
    
    console.log("âœ… ArielOS è§¸ç™¼å™¨éƒ¨ç½²å®Œæˆã€‚");
}
